<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="assets/icone.png" type="image/x-icon">
    <title>Escrevo!</title>
  
    <style>
      body {
        background-color: #000000;
        color: rgb(207, 207, 207);
        font-family:  Helvetica, sans-serif;
      }
      h1 {
        text-align: center;
        font-size: 25px;
        font-family: monospace;
        color: rgb(129, 12, 12);
      }
      h3 {
        text-align: center;
        font-size: 10px;
        font-family: monospace;
        color: rgb(104, 129, 12);
      }
      #usuario{
        margin: auto 10px;
      }
      #mensagem{
        border: solid white 1px;
        height: 470px;
        margin: 0 auto;
        background-color: #0f0f0f;
        max-width: 1000px;
        border-radius: 2px;
        padding: 10px;
        overflow-y: scroll;

      }
      #mensagens{
        font-size: smaller;

        margin-bottom: 5px;
        background-color: #000000a6;
        border-radius: 5px;
        
        align-content: center;
        padding: 7px 8px 8px 10px;
        overflow-wrap: anywhere;

        
      }
      #inputs{
        display: flex;
        justify-content: center;
        padding: 10px;
        gap: 5px;
      }
      #input-mensagem {
        height: 30px;
        width: 100%;
        max-width: 365px;
        border-radius: 20px;
        padding: 0 10px;
        
      }
      #input-mensagem:focus {
        outline: none;
        
      }
      #botao-enviar{
        border-radius: 20px;
        width: 100px;
      }
      #mensagem-log {
        margin: 0 auto;
        width: 300px;
        display: flex;
        justify-content: center;
        background-color: rgb(85, 7, 7);

        font-size: smaller;
        margin-bottom: 5px;
        border-radius: 5px;
        padding: 7px 8px 8px 10px;
        overflow-wrap: anywhere;
        
      }
      #msg-usuario{
        
        display: flex;
        justify-content: end;
        background-color: #000000a6;

        font-size: smaller;
        margin-bottom: 5px;
        border-radius: 5px;
        padding: 7px 8px 8px 10px;
        overflow-wrap: anywhere;
        max-width: 500px;
        margin-left: auto; 
        margin-right: 0;
        text-align: right;
        color: green;
        width: fit-content;
      }
      #msg-outros{
        
        display: flex;
        justify-content: start;
        background-color: #000000a6;

        font-size: smaller;
        margin-bottom: 5px;
        border-radius: 5px;
        padding: 7px 8px 8px 10px;
        overflow-wrap: anywhere;
        max-width: 500px;
        margin-left: auto; 
        margin-left: 0;
        text-align: left;
        color: green;
        width: fit-content;
      }
      

    </style>
  </head>
  <body>
    <h1>Essa aplicação é um experimento com WebSocketServer</h1>
    <h3>(estou desenvolvendo. a interface ta pessima, mas é isso. é um projetinho pra fazer aos poucos e sempre)</h3>
    <section>
      <div id="usuario">
        
      </div>
    </section>

    <section">
      <div id="mensagem"></div>
    </section>

    <section id="inputs">
      <input type="text" id="input-mensagem" maxlength="200">
      <button id="botao-enviar">Enviar</button>
    </section>

    <script>
    // cria variaveis de elementos do dom
    let usuario = document.getElementById('usuario');
    let botao = document.getElementById("botao-enviar");
    let input = document.getElementById('input-mensagem');
    let mensagem = document.getElementById('mensagem')

    
    // pega o nome do usuario, se não tiver no localstarage
    if(localStorage.getItem("nomeDeUsuario")){
      nome = localStorage.getItem("nomeDeUsuario")
    }else{
      const nomesUsuarios = [
        "shueki", "pikachu","Ratinho", "Silvio Santos", "Seu Madruga",
        "Jacaré", "Capivara", "Tubarão", "Dragão", "HackerMan","Katy Perry", "Harry Potter", "Bicho Papão", "Bob Esponja",
        "Zé", "Cleiton do Pneu", "Ednaldo Pereira", "Suco de laranja"
      ];
      let numeroUsuario = Math.round(Math.random()*18)
      nome = window.prompt("Digite seu nome: ", `${nomesUsuarios[numeroUsuario]}`);   
      (nome == null) ? nome = "Você não escolheu um nome e não tinha nome aleatorios pra vc" : localStorage.setItem("nomeDeUsuario", nome)   
    }
    
    
    // conecta ao backend
    // const ws = new WebSocket("ws://localhost:8080") // testes
    const ws = new WebSocket("wss://clear-maggy-chat-diogo-11b743c1.koyeb.app/")
    
    // verifica conexão com servidor e se usuario entrou e saiu
    ws.onopen = () => {
      // ws.send("servidor: "+ nome + " está conectado!")
      ws.send(`${nome} entrou na sala!`)

      // manda pings pro servidor pra manter a conexão por mais de 60 segundos
      setInterval(function(){
        if(ws.readyState === WebSocket.OPEN) {
          ws.send("ping")
        }
      },55000)
    }
    ws.onclose = () => {
      ws.send(`${nome} saiu na sala!`)
    }
    // cria função responsável por enviar mensagem do usuario
    function enviar(msg){
      ws.send(`${nome}: ${msg}`);
    }
    
    // add um listening no botão pra enviar
    botao.addEventListener("click", () => enviar(input.value))
    input.addEventListener("keydown", (evento) =>{
      if (evento.key ==="Enter") {
        enviar(input.value);
        input.value = ""
      }
      
    })
    
    ws.onmessage = (event) => {
      const data = event.data; // texto recebido do servidor
      let mensagens = [];
      
      // Tenta transformar o texto em objeto json
      try {
        const obj = JSON.parse(data);
        
        // Se o objeto tem um array de mensagens, usa ele
        if (Array.isArray(obj.mensagens)) {
          mensagens = obj.mensagens;
        } 
      } catch {
        // se não for JSON, usa o texto original
        mensagens = [data];
      }
    
      
      // Adiciona cada mensagem na tela
      mensagens.forEach((msg) => {
        console.log(nome)
        if(msg.startsWith(nome + ': ') && !msg.endsWith("/limpar")){
          mensagemFiltrada = msg.slice(nome.length + 2) // fiz um fateamento pra parar de exibir o nome de usuario de quem ta enviando pq é desnecessario
          mensagem.innerHTML += `<div id="msg-usuario"> ${mensagemFiltrada}</div>`
        }else if (msg.endsWith("sala!")) {
          mensagem.innerHTML += `<div id="mensagem-log"> ${msg}</div>`
        } else if (msg.endsWith("/limpar")) {
          mensagem.innerHTML += `<div id="mensagem-log">o admin limpou o chat</div>`
        } else {
          mensagem.innerHTML += `<div id="msg-outros"> ${msg}</div>` //adição de tag pra css organizar tudo | identando as mensagens corretamente
        }
      
    }
  )
  
  // dá scroll para a última mensagem aparecer
  mensagem.scrollTop = mensagem.scrollHeight;
  
};

    usuario.innerHTML = `<p><span style="font-family: monospace; font-size: 16px; color: red; ">servidor:</span> <b>${nome}</b>, você está conectado!</p>`
    </script>
  </body>
  </html>
  
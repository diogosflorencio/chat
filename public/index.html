<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="assets/icone.png" type="image/x-icon">
    <title>Escrevo!</title>
  
    <style>
      
      body {
      background-color: #e8f1e3;
      color: #333;
      font-family: Helvetica, Arial, sans-serif;
      position: relative;
    }

    h1 {
      text-align: center;
      font-size: 25px;
      font-family: monospace;
      color: #075e54;
      margin-bottom: 5px;
    }

    h3 {
      text-align: center;
      font-size: 11px;
      font-family: monospace;
      color: #128c7e;
      margin-top: 0;
    }

    #usuario {
      margin: auto 10px;
    }

    #mensagem {
      border: 1px solid #d9fdd3;
      height: 70vh;
      margin: 0 auto;
      background-color: #e6dedea6;
      background-image: url("assets/background.png"); 
      background-repeat: repeat;
      background-size: contain;
      background-position: center;
      max-width: 70vw;
      border-radius: 8px;
      padding: 10px;
      overflow-y: scroll;
      scrollbar-width: thin;
      scrollbar-color: #25d366 #ffffff;
      box-shadow: 0 0 8px #bdbdbd;
    }

    #mensagem::-webkit-scrollbar {
      width: 3px;
    }
    #mensagem::-webkit-scrollbar-track {
      background: #ffffff;
      border-radius: 5px;
    }
    #mensagem::-webkit-scrollbar-thumb {
      background-color: #25d366;
      border-radius: 5px;
    }

    #mensagens {
      font-size: smaller;
      margin-bottom: 5px;
      background-color: #dcf8c6;
      border-radius: 7px;
      align-content: center;
      padding: 7px 10px;
      overflow-wrap: anywhere;
    }

    #inputs {
      display: flex;
      justify-content: center;
      padding: 10px;
      gap: 2px;
    }

    #input-usuario {
      height: 32px;
      width: 100%;
      max-width: 5vw;
      border-radius: 20px 0 0 20px;
      padding: 0 10px;
      border: 1px solid #128c7e;
      background-color: #fff;
      color: #075e54;
    }
    #input-usuario:focus {
      outline: 2px solid #25d366;
    }

    #input-mensagem {
      height: 32px;
      width: 100%;
      max-width: 25vw;
      border-radius: 0;
      padding: 0 10px;
      border: 1px solid #128c7e;
      background-color: #fff;
      color: #075e54;
    }
    #input-mensagem:focus {
      outline: 2px solid #25d366;
    }
    
    #botao-enviar {
      border-radius: 0 20px 20px 0;
      width: 100%;
      height: 33.6px;
      border: 1px solid #128c7e;
      max-width: 5vw;
      background-color: #128c7e;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #botao-enviar:hover {
      background-color: #25d366;
      outline: 2px solid #25d366;
    }

    #botao-arquivo {
      width: 10px;
      margin: 6px;
      cursor: pointer;
    }

    #botao-arquivo-imagem {
      width: 15px;
      filter: brightness(0) saturate(100%) invert(45%) sepia(80%) saturate(384%) hue-rotate(98deg) brightness(92%) contrast(90%);
    }

    #mensagem-log {
      margin: 0 auto;
      width: 10rem;
      display: flex;
      justify-content: center;
      background-color: #e8f1e3;
      color: #075e54;
      font-size: smaller;
      margin-bottom: 5px;
      border-radius: 8px;
      padding: 7px 10px;
      overflow-wrap: anywhere;
    }

    #msg-usuario {
      display: flex;
      justify-content: end;
      background-color: #dcf8c6;
      font-size: smaller;
      margin-bottom: 6px;
      border-radius: 8px 8px 0 8px;
      padding: 8px 10px;
      overflow-wrap: anywhere;
      max-width: 500px;
      margin-left: auto;
      margin-right: 0;
      text-align: right;
      color: #075e54;
      width: fit-content;
      box-shadow: 0 1px 1px #ccc;
    }
    
    #msg-outros {
      color: #075e54;
      display: flex;
      justify-content: start;
      background-color: #ffffff;
      font-size: smaller;
      margin-bottom: 6px;
      border-radius: 8px 8px 8px 0;
      padding: 8px 10px;
      overflow-wrap: anywhere;
      max-width: 500px;
      margin-left: 0;
      text-align: left;
      width: fit-content;
      box-shadow: 0 1px 1px #ccc;
    }
    #comandos{
      position: absolute;
      right: 5px;
      top: 80px;
    }
    #comandos{
      text-align: center;
      font-size: 9px;
      font-family: monospace;
      color: #128c7e;
      margin-top: 0;
    }
    @media (max-width: 1285px) {
      #comandos{
        font-size: 7px;
    }
   
    }
    @media (max-width: 1285px) {
      #comandos{
        font-size: 6px;
    }
    @media (max-width: 1000px) {
      #comandos{
        display: none;
    }
   
   
    }
    @media (max-width: 500px) {
      #mensagem {
        border: 1px solid #d9fdd3;
        height: 65vh;
        margin: 0 auto;
        background-image: url("/public/assets/background.png");
        background-color: rgb(218, 216, 216);
        background-repeat: repeat;
        background-size: contain;
        background-position: center;
        max-width: 95vw;
        border-radius: 8px;
        padding: 10px;
        overflow-y: scroll;
        background-blend-mode: overlay;
      }
    
      #input-mensagem {
        width: 100%;
        margin: 0%;
        max-width: 100vw;
      }
      #input-usuario {
        width: 100%;
        max-width: 15vw;
      }
      #botao-enviar {
        width: 100%;
        max-width: 10vw;
      }
    }
  }


    </style>
  </head>
  <body>
    <h1>Essa aplicação é um experimento com WebSocketServer</h1>
    <h3>(estou desenvolvendo. a interface e funcionalidades estão em constante melhorias)</h3>
    <section>
      <div id="usuario">
        
      </div>
    </section>

    <section">
      <div id="mensagem"></div>
      
    </section>
    <section id="comandos">
      <ul>
        <h3>comandos: </h3>
        <li>/imagem + link - para enviar imagens</li>
        <li>/limpar - excluir todas as mensagens</li>

      </ul>
    </section>


    <div id="modal-imagem" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80vw; height: 80vh; background-color: rgba(0, 0, 0, 0.9); z-index: 9999; border-radius: 8px; cursor: pointer; padding: 20px; box-sizing: border-box;">
      <img id="imagem-modal" src="" alt="" style="max-width: 100%; max-height: 100%; width: 500%; object-fit: contain; display: block; margin: auto;">
    </div>

    <section id="inputs">

      
      <input placeholder="@Usuario" ="text" id="input-usuario" maxlength="20">

      <input type="text" id="input-mensagem" maxlength="1000" >

      <button id="botao-enviar">➔</button>
      
      <input type="file" id="seletorImagem" accept="image/*" style="display: none;">
      <div id="botao-arquivo"><img id="botao-arquivo-imagem" src="assets/image.png" alt=""></div>
    </section>

    <script>
    // cria variaveis de elementos do dom
    let usuario = document.getElementById('usuario');
    let inputUsuario = document.getElementById('input-usuario');
    let botao = document.getElementById("botao-enviar");
    let input = document.getElementById('input-mensagem');
    let mensagem = document.getElementById('mensagem')
    const modalImagem = document.getElementById('modal-imagem');
    const imagemModal = document.getElementById('imagem-modal');

    
    // pega o nome do usuario, se não tiver no localstarage
    if(localStorage.getItem("nomeDeUsuario")){
      nome = localStorage.getItem("nomeDeUsuario")

    }else{
      const nomesUsuarios = [
      "Sheldon Cooper", "Penny", "Leonard Hofstadter", "Raj Koothrappali", "Howard Wolowitz",
      "Michael Scott", "Dwight Schrute", "Jim Halpert", "Pam Beesly", "Barack Obama",
      "Rick Sanchez", "Morty Smith", 
      "Walter White", "Jesse Pinkman", "Saul Goodman", "Goku",
      "Homer Simpson", "Bart Simpson", "Lisa Simpson", "Marge Simpson","Forrest Gump", "Buzz Lightyear", "Woody",
      "Seu Madruga", "Chiquinha", "Harry Potter", "Elon Musk", "Hércules",
      "Felipe Neto", "Neil Armstrong", "Chapolin Colorado", "Darth Vader", "Indiana Jones",
      "Mochileiro da Galáxia", "Lula Molusco", "Dona Florinda", "Tony Stark", "Cleópatra","Naruto Uzumaki", "Yoda", "Albert Einstein", "Lady Gaga"
    ];

      let numeroUsuario = Math.round(Math.random()*18)
      nome = window.prompt("Digite seu nome: ", `${nomesUsuarios[numeroUsuario]}`);   
      (nome == null) ? nome = "Sem nome" : localStorage.setItem("nomeDeUsuario", nome)   
    }

    inputUsuario.value = `${nome}`

    inputUsuario.addEventListener("change", () => {
      nome = inputUsuario.value
      localStorage.setItem("nomeDeUsuario",nome)
      usuario.innerHTML = `<p><span style="font-family: monospace; font-size: 16px; color: red;">servidor:</span> <b>${nome}</b>, você está <span style="color:green">conectado!</span>!</p>`;

    })
    
    
    // conecta ao backend
    // const ws = new WebSocket("ws://localhost:8080") // testes
    const ws = new WebSocket("wss://clear-maggy-chat-diogo-11b743c1.koyeb.app/")
    
    // verifica conexão com servidor e se usuario entrou e saiu
    ws.onopen = () => {
      usuario.innerHTML = `<p><span style="font-family: monospace; font-size: 16px; color: red; ">servidor:</span> <b>${nome}</b>, você está <span style="color:green">conectado!</span>!</p>`

      // ws.send("servidor: "+ nome + " está conectado!")
      ws.send(`${nome} entrou na sala!`)

      // manda pings pro servidor pra manter a conexão por mais de 60 segundos
      setInterval(function(){
        if(ws.readyState === WebSocket.OPEN) {
          ws.send("ping")
        }
      },50000)
    }
    ws.onclose = () => {
      usuario.innerHTML = `<p><span style="font-family: monospace; font-size: 16px; color: red; ">servidor:</span> <b>${nome}</b>, você está <span style="color:red">desconectado! (reinicie a página)</span></p>`

    }
    // func pra enviar as coisas
    function enviar(msg){
      ws.send(`${nome}: ${msg}`);
    }
    
  
   

function ampliarImagem(img) {
  imagemModal.src = img.src;
  modalImagem.style.display = 'flex';
}

mensagem.addEventListener("click", (event) => {
  if (event.target && event.target.classList.contains("imagem-enviada")) {
    ampliarImagem(event.target);
  }
});

modalImagem.addEventListener("click", () => {
  modalImagem.style.display = 'none';
  imagemModal.src = '';
});

let agora = new Date();
let hora = agora.getHours().toString().padStart(2, "0");
let minutos = agora.getMinutes().toString().padStart(2, "0");

let tempoHTML = `<span style="font-size: 9px; color: #075e54; vertical-align: baseline; align-self:end; margin-left: 4px;">${hora}:${minutos}</span>`;


input.addEventListener("keydown", (evento) => {
  if (evento.key === "Enter") {
    const texto = input.value.trim();
    if (texto !== "") {
      if (texto.toLowerCase().includes("/imagem")) {
        const url = texto.replace(/imagem/i, "").trim();
        enviar(`<img class="imagem-enviada" src="${url}" alt="imagem enviada" style="width:200px">`); 
      } else if (texto.includes("/limpar")){
      enviar(`${texto}`);
      } else {
        enviar(`${texto} ${tempoHTML}`);
      }
    } else {
      console.log("msg vazia");
    }
    input.value = "";
  }
});

botao.addEventListener("click", () => {
  const texto = input.value.trim();
  if (texto !== "") {
    if (texto.toLowerCase().includes("/imagem")) {
      const url = texto.replace(/imagem/i, "").trim();
      enviar(`<img class="imagem-enviada" src="${url}" alt="imagem enviada" style="width:200px">`);
    } else if (texto.includes("/limpar")){
      enviar(`${texto}`);
    } else {
      enviar(`${texto} ${tempoHTML}`);
    }
  } else {
    console.log("msg vazia");
  }
  input.value = "";
});




    
    ws.onmessage = (event) => {
      const data = event.data; // texto recebido do servidor
      let mensagens = [];
      
      // Tenta transformar o texto em objeto json
      try {
        const obj = JSON.parse(data);
        
        // Se o objeto tem um array de mensagens, usa ele (pq existe as mensagens e o historico de mensagens)
        if (Array.isArray(obj.mensagens)) {
          mensagens = obj.mensagens;
        } 
      } catch {
        // se não for JSON, usa o texto original
        mensagens = [data];
      }
    
      
      // Adiciona cada mensagem na tela
      mensagens.forEach((msg) => {
        if(msg.startsWith(nome + ': ') && !msg.includes("/limpar")){
          mensagemFiltrada = msg.slice(nome.length + 2) // fiz um fateamento pra parar de exibir o nome de usuario de quem ta enviando pq é desnecessario
          mensagem.innerHTML += `<div id="msg-usuario"> ${mensagemFiltrada}</div>`
        }else if (msg.endsWith("sala!")) {
          mensagem.innerHTML += `<div id="mensagem-log"> ${msg}</div>`
        } else if (msg.includes("/limpar")) {
          mensagem.innerHTML += `<div id="mensagem-log">o admin limpou o chat</div>`
        } else {
          mensagem.innerHTML += `<div id="msg-outros"> ${msg}</div>` //adição de tag pra css organizar tudo | identando as mensagens corretamente
        }
      
    }
  )
  
  // dá scroll para a última mensagem aparecer
  mensagem.scrollTop = mensagem.scrollHeight;
  
};

    </script>
  </body>
  </html>
  